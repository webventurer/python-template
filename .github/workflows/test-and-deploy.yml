# See https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/

name: CI/CD Pipeline

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/app
      DOTENV_PRIVATE_KEY_VAULT: ${{ secrets.DOTENV_PRIVATE_KEY_VAULT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version-file: .python-version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools
          [ -f requirements.txt ] && pip-sync requirements.txt requirements-dev.txt || pip-sync requirements-dev.txt
          make install-local

      - name: Check dotenvx private key is present
        run: |
          if [ -z "${DOTENV_PRIVATE_KEY_VAULT}" ]; then
            echo "DOTENV_PRIVATE_KEY_VAULT is not set"
            exit 1
          fi

      - name: Install dotenvx
        run: |
          curl -sfS https://dotenvx.sh/install.sh | sh
          dotenvx run --env-file .env.vault -- python check_env.py

      - name: Run linter
        run: make lint

      - name: Check formatting
        run: make format

      - name: Check types
        run: make types

      - name: Run tests
        run: |
          dotenvx run --env-file .env.vault -- pytest -o console_output_style=classic -v || ([ $? = 5 ] && exit 0 || exit $?)

  deploy:
    runs-on: ubuntu-latest
    needs: test
    env:
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/app
      DOTENV_PRIVATE_KEY_VAULT: ${{ secrets.DOTENV_PRIVATE_KEY_VAULT }}
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy with flyctl
        run: |
          flyctl deploy --no-cache --remote-only --build-secret DOTENV_PRIVATE_KEY_VAULT=${{ secrets.DOTENV_PRIVATE_KEY_VAULT }}
